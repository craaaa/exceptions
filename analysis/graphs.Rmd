---
title: "make_graphs"
output: html_document
date: "2024-03-15"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggrepel)
library(gghalves)
library(colorBlindness)
library(showtext)
font_add("fira", "FiraSans-Regular.ttf")
font_add("firal", "FiraSans-Light.ttf")
library(patchwork)
library(ggpattern)

source(here("analysis", "utils.R"))
source(here("analysis", "data_cleaning.R"))
theme_set(theme_light() + theme(text=element_text(size=14,  family="fira")))
```

## Experiment 1A

```{r}
mean_human_for_duckbill %>% 
  ggplot(aes(x=sentence_type, y=mean)) +
  facet_grid(cols=vars(verb_class)) +
  geom_point(aes(group=verb, color=verb_class)) +
  geom_line(aes(group=interaction(verb), color=verb_class)) +
  geom_errorbar(aes(ymin=error_1, ymax=error_2,colour=verb_class), width = 0.1) +
  geom_text_repel(data = subset(mean_human_for_duckbill, sentence_type == "passive"), 
                  aes(label = verb, segment.linetype = 2), size=3.5, family='fira', hjust= 'right', vjust = 0, nudge_x = 1.5) +
  scale_colour_manual(values = verb_class_colours) +
  #labs(title="Human ratings of active and passive sentences by verb",
  #     caption=paste("Human n=", toString(NUM_PARTICIPANTS))) +
  xlab(element_blank()) +
  ylab("Mean sentence score") +
  theme(legend.position="none",
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
  ) +
  scale_y_continuous(limits=c(0,100)) +
  scale_x_discrete(labels = c("Active", "Passive"), expand = expansion(mult = 0.5))# + 
  # theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggsave(filename = here("analysis", "human_duckbill.pdf"), device="pdf", width=13, height=4, units = "in")
```

## BLiMP

```{r}
blimp_results %>%
  ggplot(aes(x=test, y=accuracy, fill=file_name)) +
  geom_col(position='dodge') +
  facet_wrap(vars(group), scales="free_x") +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1),
        legend.position = "bottom") +
  labs(title="Performance on BLiMP", fill="Model") +
  scale_fill_manual(values=c("#269773", "#288F78","#2A867D", "#2B7E81", "#2D7586", "#555555"))
```

```{r}
blimp_overall_mean <- blimp_results_mean %>%
  select(!c(accuracies, error_1, error_2)) %>%
  mutate(test = "overall",
         group = "overall",
         ppl = "1")

blimp_results %>%
  bind_rows(lstm_data) %>%
  filter(group == "Argument Structure") %>%
  rbind(blimp_overall_mean) %>%
  mutate(test = relevel(factor(test), ref= 'overall')) %>%
  ggplot(aes(y=test, x=accuracy, color=file_name)) +
  geom_point(aes(shape=file_name), size=2) +
  theme(text = element_text(size=12),
        legend.position = "bottom") +
  labs(shape="Model", color="Model") +
  ylab(element_blank()) +
  xlab("Accuracy") +   
  scale_shape_manual(labels=c("Model 1","Model 2","Model 3","Model 4","Model 5","GPT-2","LSTM"),
                       values=c(15, 17, 19, 9, 10, 8, 3,3)) +
  scale_y_discrete(limits=rev,
                   labels=c("overall" = "Overall",
                            "animate_subject_passive" = "Animate Subject Passive \n Amanda was respected by some waitresses/*pictures.",
                            "animate_subject_trans" = "Animate Subject Transitive\nDanielle/*The eye visited Irene.",
                            "causative" = "Causative\nAaron breaks/*appeared the glass.",
                            "drop_argument" = "Drop Argument\nThe Lutherans couldn't skate around/*disagree with.",
                            "inchoative" = "Inchoative\nA screen was fading/*cleaning.",
                            "intransitive" = "Intransitive\nSome glaciers are vaporizing/*scaring.",
                            "passive_1" = "Passive 1\nJeffrey's sons are insulted/*smiled by Tina's supervisor.",
                            "passive_2" = "Passive 2\nMost cashiers are disliked/*flirted.",
                            "transitive" = "Transitive\nA lot of actresses' nieces have toured/*coped that art gallery."
                            )
                   ) +
  geom_hline(yintercept=9.5, linetype = "solid", color="black") +
  geom_vline(xintercept=0.5, linetype = "dashed", color="darkgray") +
  scale_x_continuous(limits=c(0,1), labels = scales::percent)+
  scale_color_manual(labels=c("Model 1","Model 2","Model 3","Model 4","Model 5","GPT-2","LSTM"),
                    values=c("#269773", "#288F78","#2A867D", "#2B7E81", "#2D7586", "#222222",  "#555555"))
ggsave(here("analysis", "blimp_argument_structure.pdf"), device="pdf", width=9, height=4, units = "in")

```

```{r}

blimp_results_mean %>%
  ggplot(aes(x=file_name, y=accuracy, ymin=error_1, ymax=error_2)) +
  geom_col(position='dodge', aes(fill=file_name)) +
  geom_errorbar(width=0.4) +
  geom_hline(yintercept=0.5, linetype="dashed", color='#444444') +
  labs(fill="Model") +
  ylab("Mean overall accuracy") +
  scale_y_continuous(limits=c(0,1), labels=scales::percent) +
  scale_x_discrete(labels=c("Model 1","Model 2","Model 3","Model 4","Model 5","GPT-2","LSTM")) +
  scale_fill_manual(values=c("#269773", "#288F78","#2A867D", "#2B7E81", "#2D7586", "#333333",  "#666666")) +
  theme(legend.position = "none") +
  xlab(element_blank()) 

ggsave(filename = "average_blimp.pdf", device="pdf", width=10, height=4, units = "in")
```

```{r}
blimp_results_mean %>% 
  filter(file_name != "gpt2.csv" & file_name != "lstm") %>% 
  summarise(accuracy = mean(accuracy))
```

```{r}
blimp_results %>% filter(!str_detect(blimp_results$file_name, "gpt")) %>%
  group_by(file_name, group, ppl) %>%
  summarise(accuracy = mean(accuracy)) %>%
  ggplot(aes(x=ppl, y=accuracy)) +
  geom_point() +
  geom_line() +
  ylab("Mean accuracy in category") +
  xlab("Validation set perplexity") +
  facet_wrap(vars(group))
```

## Comparison

```{r}
summary_all_100m %>%
  filter(corpus_type == "default") %>%
  ggplot(aes(x=human_mean, y=mean)) +
  geom_smooth(aes(alpha=0.8), method="lm") +
  geom_point(aes(color=verb_class)) +
  geom_errorbar(aes(ymin=error_1, ymax=error_2, color=verb_class, alpha=0.8)) +
  geom_errorbarh(aes(xmin=human_error_1, xmax=human_error_2, color=verb_class, alpha=0.8)) +
  xlab("Mean human passive drop") +
  ylab("Mean model passive drop") +
  geom_text_repel(aes(label=verb), min.segment.length = 0, size=3.5, max.overlaps= Inf, segment.linetype = 2, family='firal', nudge_x = 1, nudge_y = 0.4) +
  scale_x_continuous(limits = c(-12, 87), breaks=seq(0, 80, by = 20)) +
  scale_y_continuous(limits=c(-10,40), breaks=seq(0,30, by=10)) +
  theme(legend.position="bottom", legend.title = element_blank()) +
  scale_color_manual(values=verb_class_colours) +
  ylim(-10, 30) +
  guides(alpha="none", colour = guide_legend(nrow = 1))

ggsave(here("analysis", "summary_all.pdf"), device="pdf", width=9, height=6, units="in")
```

```{r}
mean_human_by_item <- scores_human %>% group_by(verb, verb_class, frame, sentence_type) %>%
  summarise(mean=mean(score)) %>%
  mutate(
      frame = case_when((verb_class == "Agent-Patient" | verb_class == "Experiencer-Theme") & frame %% 5 == 1 ~ paste('A',verb),
                   (verb_class == "Agent-Patient" | verb_class == "Experiencer-Theme") & frame %% 5 == 2 ~ paste('B',verb),
                   (verb_class == "Agent-Patient" | verb_class == "Experiencer-Theme")& frame %% 5 == 3~ paste('C',verb),
                   (verb_class == "Agent-Patient" | verb_class == "Experiencer-Theme") & frame %% 5 == 4 ~ paste('D',verb),
                   (verb_class == "Agent-Patient" | verb_class == "Experiencer-Theme") & frame %% 5 == 0 ~ paste('E',verb),
                   .default = as.character(frame),
                   ),
  ) %>% select(!verb_class)

mean_model_by_item <- minicons %>% 
  filter(corpus_type =="default") %>%
  pivot_longer(cols = c(active_score, passive_score), names_to = "sentence_type", names_pattern = "(.*)_score", values_to = "score") %>%
  group_by(verb, frame, sentence_type) %>%
  summarise(mean=mean(score))

mean_all_by_item <- full_join(mean_human_by_item, mean_model_by_item, by=join_by(verb, frame, sentence_type))

mean_all_by_itecor.test(x = mean_all_by_item$ mean.x,
          y = mean_all_by_item$mean.y,
         alternative="two.sided",
         method= "pearson")
```

```{r}
summary_all_100m %>%
  filter(verb_class == "Agent-Patient" | verb_class == "Duration") %>%
  ggplot(aes(x=human_mean, y=mean)) +
  geom_smooth(data=summary_all_100m, method="lm") +
  geom_point(aes(color=verb_class)) +
  geom_point(data= summary_all_100m, aes(x=human_mean, y=mean), color="grey") +
  geom_errorbar(aes(ymin=error_1, ymax=error_2, color=verb_class)) +
  geom_errorbarh(aes(xmin=human_error_1, xmax=human_error_2, color=verb_class)) +
  xlab("Mean human passive drop") +
  ylab("Mean model passive drop") +
  geom_text_repel(aes(label=verb), nudge_x = 1, nudge_y = 0.4) +
  theme(legend.position="bottom", legend.title = element_blank()) +
  scale_color_manual(values=verb_class_colours)
```

```{r}
ggsave(here("analysis", "summary_selected.pdf"), device="pdf", width=8, height=6, units="in")
```

```{r}
labels <- summary_all_default %>%
  group_by(corpus_type) %>%
  summarise(cor = cor(human_mean, mean, method= "spearman"),
            cor = sprintf("r == %.2f", cor))

summary_all_default %>%
  ggplot(aes(x=human_mean, y=mean)) +
  facet_wrap(vars(corpus_type)) +
  geom_smooth(method="lm") +
  geom_point(aes(color=verb_class)) +
  geom_errorbar(aes(ymin=error_1, ymax=error_2, color=verb_class)) +
  geom_errorbarh(aes(xmin=human_error_1, xmax=human_error_2, color=verb_class)) +
  xlab("Mean human passive drop") +
  ylab("Mean model passive drop") +
  geom_text(data=labels, aes(label = cor), x = 60, y = 0, parse=TRUE, hjust = 0) +
  geom_text_repel(aes(label=verb), nudge_x = 1, nudge_y = 0.4) +
  theme(legend.position="bottom", legend.title = element_blank()) +
  scale_color_manual(values=verb_class_colours)

```

```{r}
minicons %>% 
  filter(verb_class == "Agent-Patient" | verb_class == "Duration") %>%
  filter(verb == 'carried') %>%
  ggplot(aes(x=source_verb, y=pass_drop)) +
  facet_wrap(vars(corpus_type)) +
  geom_boxplot() +
  geom_point() +
  labs(title="Passive drop of sentences with the verb 'carried'") +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))
```

```{r}
minicons %>% 
  filter(verb_class == "Agent-Patient" | verb_class == "Duration") %>%
  filter(verb == 'lasted') %>%
  filter(corpus_type != 'frequency') %>%
  ggplot(aes(x=target_verb, y=pass_drop)) +
  facet_wrap(vars(corpus_type)) +
  geom_boxplot() +
  geom_point() +
  labs(title="Passive drop of sentences with the verb 'lasted'") +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))
```

## Experiment 2

```{r}
minicons %>% 
  mutate(frame = factor(frame)) %>%
  filter(verb_class == "Agent-Patient" | verb_class == "Duration") %>%
  filter(altered) %>%
  group_by(file_name, verb_class, verb, source_verb, target_verb, corpus_type, seed) %>%
  left_join(baselines, by=join_by(source_verb, target_verb, verb_class)) %>%
  ggplot(aes(x=corpus_type.x, y=pass_drop, ymin=error_1, ymax=error_2)) +
  facet_grid(rows=vars(source_verb), cols=vars(target_verb), scales="free_x") +
  scale_x_discrete(labels=c('Reduce\npassive freq.', 'Replace active\nsentence frame')) +
  geom_half_boxplot() + 
  geom_half_point_panel(aes(color=frame)) +
  geom_hline(aes(yintercept=baseline)) +
  ylab("Passive Drop") +
  xlab(element_blank()) +
  labs(title="Passive drop when trained on counterfactual corpora") +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))

ggsave(filename=here("analysis", "comparative.png"), device="png", width=10, height=8, units="in")
```

```{r}
minicons %>% 
  filter(verb_class == "Agent-Patient" | verb_class == "Duration") %>%
  filter(altered) %>%
  ggplot(aes(y=pass_drop, x=source_verb)) +
  facet_grid(cols=vars(target_verb), scales="free_x") +
  geom_half_boxplot() + 
  geom_half_point() +
  geom_hline(data=baselines %>% filter(lemma==target_verb), aes(yintercept=baseline), linetype='dashed') +
  labs(color="Passive frequency source") +
  ylab("Passive Drop") +
  theme(legend.position = "bottom")

ggsave(filename=here("analysis", "freq_boxplot.png"), device="png", width=8, height=6, units="in")
```

```{r}
minicons %>% 
  filter(verb_class == "Agent-Patient" | verb_class == "Duration") %>%
  filter(altered) %>%
  group_by(file_name, verb_class, verb, source_verb, target_verb, corpus_type, seed) %>%
  left_join(baselines, by=join_by(source_verb, target_verb, verb_class)) %>%
  ggplot(aes(y=pass_drop, x=source_verb, ymin=error_1, ymax=error_2, color=target_verb)) +
  facet_wrap(vars(source_verb), scales="free_x") +
  geom_half_boxplot() + 
  geom_half_point() +
  geom_hline(data=baselines %>% filter(lemma==source_verb), aes(yintercept=baseline), linetype='dashed') +
  labs(color="Sentence frame source") +
  ylab("Passive Drop") +
  xlab(element_blank()) +
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank(), legend.position = "bottom")
```

```{r}
mean_minicons_by_frame %>% 
  filter(verb_class == "Agent-Patient" | verb_class == "Duration") %>%
  filter((altered & corpus_type == "frequency")) %>%
  rbind(baselines_frame %>% filter(lemma == target_verb) %>% select(!c(lemma))) %>%
  ggplot(aes(y=mean, x=corpus_type, ymin=error_1, ymax=error_2)) +
  facet_grid(cols=vars(target_verb), rows=vars(source_verb)) +
  geom_hline(data=baselines %>% filter(lemma==source_verb), aes(yintercept=baseline), linetype='dashed', color='darkgray') +
  geom_point() +
  geom_line(aes(group=frame)) +
  geom_errorbar(width=0.1) +
  scale_x_discrete(label = c("Original\nCorpus", "Modified\nCorpus"), expand = expansion(mult = 0.5)) +
  labs(color="Verb type",
       x=element_blank()) +
  ylab("Passive Drop") +
  ylim(-5,30) +
  theme(legend.position = "bottom",
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        axis.title.x = element_text(margin = margin(t = 10, b=-5)),
        axis.title.y = element_text(margin = margin(r = 10)),
)
ggsave(here("analysis", "freq_change_by_sent.pdf"), device="pdf", width=9, height=5, units="in")
```

```{r}
mean_minicons_by_frame %>% 
  filter(verb_class == "Agent-Patient" | verb_class == "Duration") %>%
  filter((altered & corpus_type == "swap")) %>%
  rbind(baselines_frame %>% filter(lemma == source_verb) %>% select(!c(lemma))) %>%
  ggplot(aes(y=mean, x=corpus_type, color=frame, ymin=error_1, ymax=error_2)) +
  facet_grid(cols=vars(source_verb), rows=vars(target_verb)) +
  geom_point() +
  geom_line(aes(group=frame)) +
  geom_errorbar(width=0.1) +
  geom_hline(data=baselines %>% filter(lemma == target_verb), aes(yintercept=baseline), linetype='dashed', color='darkgray') +
  scale_x_discrete(label = c("Original", "Counterfactual")) +
  scale_colour_manual(values=c("#56B4E9", "#009E73", "#0072B2", "#D55E00", "#E69F00")) +
  labs(color="Sentence Frame",
       x="Training Corpus") +
  ylab("Passive Drop") +
  theme(legend.position = "bottom",
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        axis.title.x = element_text(margin = margin(t = 10, b=-5)),
        axis.title.y = element_text(margin = margin(r = 10)),
        legend.box.background = element_rect(linewidth=0, fill = NULL , colour = NULL))
ggsave(here("analysis", "swap_change_by_sent.pdf"), device="pdf", width=8, height=5, units="in")

```

```{r}
mean_minicons_by_verb %>% 
  filter((corpus_type == "frequency")) %>%
  group_by(verb, verb_class, corpus_type, altered, source_verb, target_verb) %>%
  summarise(mean = mean(mean),
            error_1 = mean(error_1),
            error_2 = mean(error_2)) %>%
  rbind(baselines_verb %>% select(!c(lemma))) %>%
  mutate(altered = if_else(get_lemma(verb) == target_verb, "Mutating Verb", 
                           if_else(get_lemma(verb) == source_verb, "Target Verb", "Other Verb")),
         altered = factor(altered, levels=c("Mutating Verb", "Target Verb", "Other Verb")),
         alpha = if_else(altered == "Other Verb", 0.01, 1.0)) %>%
  ggplot(aes(y=mean, x=corpus_type, color=altered, alpha=alpha, ymin=error_1, ymax=error_2)) +
  geom_point() +
  geom_errorbar(width=0.1, linetype="solid") +
  geom_line(aes(group=verb, linetype=altered)) +
  facet_grid(cols=vars(target_verb), rows=vars(source_verb)) +
  scale_x_discrete(element_blank(),
                   label = c("Original\nCorpus", "Modified\nCorpus")) +
  scale_linetype_manual(element_blank(), values=c("solid", "dashed", "solid")) +
  scale_color_manual(element_blank(), values=c("#D55E00", "#b66dff", "#000000"),
                     guide = guide_legend(override.aes = list(
                         linetype = c("solid", "dashed", "solid"),
                         shape = c(NA, NA, NA)))) +
  guides(
    alpha="none",
    linetype=guide_legend(keywidth = 3, keyheight = 1)
    ) +
  ylab("Passive Drop") +
  theme(legend.position = "bottom",
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        axis.title.x = element_text(margin = margin(t = 10, b=-5)),
        axis.title.y = element_text(margin = margin(r = 10)),
        legend.box.background = element_rect(linewidth=0, fill = NULL , colour = NULL))
ggsave(here("analysis", "freq_change_source_target.pdf"), device="pdf", width=9, height=5, units="in")
```

```{r}
mean_minicons_by_verb %>% 
  filter((corpus_type == "swap")) %>%
  group_by(verb, verb_class, corpus_type, altered, source_verb, target_verb) %>%
  summarise(mean = mean(mean),
            error_1 = mean(error_1),
            error_2 = mean(error_2)) %>%
  rbind(baselines_verb %>% select(!c(lemma))) %>%
  mutate(altered = if_else(get_lemma(verb) == source_verb, "Mutating", if_else(get_lemma(verb) == target_verb, "Target", "Other")),
         altered = factor(altered, levels=c("Mutating", "Target", "Other")),
         alpha = if_else(altered == "Other", 0.15, 1.0)) %>%
  ggplot(aes(y=mean, x=corpus_type, color=altered, linetype=altered, alpha=alpha, ymin=error_1, ymax=error_2)) +
  facet_grid(rows=vars(target_verb), cols=vars(source_verb)) +
  scale_x_discrete(label = c("Original", "Counterfactual")) +
  scale_linetype_manual(values=c("solid", "dashed", "solid")) +
  scale_color_manual(values=c("#009292", "#b66dff", "#000000")) +
  geom_point() +
  guides(alpha="none") +
  geom_line(aes(group=verb)) +
  geom_errorbar(width=0.1, linetype="solid") +
  labs(color="Verb",
       linetype="Verb",
       x="Training corpus") +
  ylab("Passive Drop") +
  theme(legend.position = "bottom",
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        axis.title.x = element_text(margin = margin(t = 10, b=-5)),
        axis.title.y = element_text(margin = margin(r = 10)),
        legend.box.background = element_rect(linewidth=0, fill = NULL , colour = NULL))

```

```{r}
minicons_all_scores %>% 
  filter(corpus_type != "frequency") %>%
  mutate(altered = get_lemma(verb) == source_verb) %>%
  group_by(corpus_type, source_verb, target_verb, altered) %>%
  summarise(recorded_scores = list(unlist(list(recorded_scores)))) %>%
  mutate(mean = sapply(recorded_scores, mean),
          error = lapply(recorded_scores, bayesian_error)) %>%
    unnest_wider(error, names_sep="_") %>%
  ggplot(aes(x=corpus_type, y=mean, ymin=error_1, ymax=error_2,color=altered)) +
  facet_grid(cols=vars(source_verb), rows=vars(target_verb)) +
  geom_line(aes(group=altered, linetype=altered)) +
  geom_errorbar(width=0.1, linetype="solid") +
  scale_y_continuous(limits = c(0, 30)) +
  scale_x_discrete(label = c("Original\nCorpus", "Modified\nCorpus")) +
  scale_linetype_manual(label = c("Non-Mutating Verb", "Mutating Verb"), values=c("solid", "dashed")) +
  scale_color_manual(label = c("Non-Mutating Verb", "Mutating Verb"), 
                     values=c("#0072B2", "#D55E00"),
                     guide = guide_legend(override.aes = list(
                         linetype = c("solid", "dashed"),
                         shape = c(NA, NA)))) +
  labs(color=element_blank(),
       linetype=element_blank(),
       x=element_blank(),
       y="Passive Drop") +
  guides(linetype=guide_legend(keywidth = 3, keyheight = 1)) +
  theme(legend.position = "bottom",
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        axis.title.x = element_text(margin = margin(t = 10, b=-5)),
        axis.title.y = element_text(margin = margin(r = 10)),
        legend.box.background = element_rect(linewidth=0, fill = NULL , colour = NULL))
ggsave(here("analysis", "swap_change.pdf"), device="pdf", width=8, height=5, units="in")

```

```{r}
minicons_all_scores %>% 
  filter(corpus_type != "swap") %>%
  mutate(altered = get_lemma(verb) == target_verb) %>%
  group_by(corpus_type, source_verb, target_verb, altered) %>%
  summarise(recorded_scores = list(unlist(list(recorded_scores)))) %>%
  mutate(mean = sapply(recorded_scores, mean),
          error = lapply(recorded_scores, bayesian_error)) %>%
    unnest_wider(error, names_sep="_") %>%
  ggplot(aes(x=corpus_type, y=mean, ymin=error_1, ymax=error_2, linetype=altered, color=altered)) +
  facet_grid(cols=vars(target_verb), rows=vars(source_verb)) +
  geom_point() +
  geom_line(aes(group=altered)) +
  geom_errorbar(width=0.1, linetype="solid") +
  scale_y_continuous(limits = c(0, 12), breaks=seq(0,12, by=4)) +
scale_x_discrete(label = c("Original\nCorpus", "Modified\nCorpus")) +
  scale_linetype_manual(label = c("Non-Mutating Verb", "Mutating Verb"), values=c("solid", "dashed")) +
  scale_color_manual(label = c("Non-Mutating Verb", "Mutating Verb"), 
                     values=c("#0072B2", "#D55E00"),
                     guide = guide_legend(override.aes = list(
                         linetype = c("solid", "dashed"),
                         shape = c(NA, NA)))) +
  labs(color=element_blank(),
       linetype=element_blank(),
       x=element_blank(),
       y="Passive Drop") +
  guides(linetype=guide_legend(keywidth = 3, keyheight = 1)) +
  theme(legend.position = "bottom",
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        axis.title.x = element_text(margin = margin(t = 10, b=-5)),
        axis.title.y = element_text(margin = margin(r = 10)),
        legend.box.background = element_rect(linewidth=0, fill = NULL , colour = NULL))

ggsave(here("analysis", "freq_change.pdf"), device="pdf", width=9, height=6, units="in")

```

```{r}
mean_minicons_by_verb %>% 
  filter((corpus_type == "swap")) %>%
  group_by(verb, verb_class, corpus_type, altered, source_verb, target_verb) %>%
  summarise(mean = mean(mean),
            error_1 = mean(error_1),
            error_2 = mean(error_2)) %>%
  rbind(baselines_verb %>% select(!c(lemma))) %>%
  mutate(altered = if_else(get_lemma(verb) == target_verb, "Mutating Verb", 
                           if_else(get_lemma(verb) == source_verb, "Target Verb", "Other Verb")),
         altered = factor(altered, levels=c("Target Verb", "Mutating Verb", "Other Verb")),
         alpha = if_else(altered == "Other Verb", 0.01, 1.0)) %>%
  ggplot(aes(y=mean, x=corpus_type, color=altered, alpha=alpha, ymin=error_1, ymax=error_2)) +
  geom_point() +
  geom_errorbar(width=0.1, linetype="solid") +
  geom_line(aes(group=verb, linetype=altered)) +
  facet_grid(cols=vars(target_verb), rows=vars(source_verb)) +
  scale_x_discrete(element_blank(),
                   label = c("Original\nCorpus", "Modified\nCorpus")) +
  scale_linetype_manual(element_blank(), values=c("solid", "dashed", "solid")) +
  scale_color_manual(element_blank(), values=c("#b66dff", "#D55E00","#000000"),
                     guide = guide_legend(override.aes = list(
                         linetype = c("solid", "dashed", "solid"),
                         shape = c(NA, NA, NA)))) +
  guides(
    alpha="none",
    linetype=guide_legend(keywidth = 3, keyheight = 1)
    ) +
  ylab("Passive Drop") +
  theme(legend.position = "bottom",
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        axis.title.x = element_text(margin = margin(t = 10, b=-5)),
        axis.title.y = element_text(margin = margin(r = 10)),
        legend.box.background = element_rect(linewidth=0, fill = NULL , colour = NULL))
ggsave(here("analysis", "freq_change_source_target.pdf"), device="pdf", width=9, height=5, units="in")
```

```
```{r}
minicons_all_scores %>% 
  rowwise() %>%
  mutate(mean_freq_diff = mean(default) - mean(frequency),
            error_freq_diff = list(bayesian_difference_error(default, frequency)),
            mean_swap_diff = mean(default) - mean(swap),
            error_swap_diff = list(bayesian_difference_error(default, swap))) %>%
  unnest_wider(error_freq_diff, names_sep="_") %>%
  unnest_wider(error_swap_diff, names_sep="_") %>%
  ggplot(aes(y=mean_swap_diff, 
             x=interaction(verb), 
             fill=(get_lemma(verb) == target_verb), 
             ymin=error_swap_diff_1, ymax=error_swap_diff_2)) +
  facet_grid(cols=vars(target_verb), rows=vars(source_verb)) +
  geom_bar(stat="identity") +
  geom_errorbar(width=0.1) +
  labs(fill="Intervened verb",
              title="Effect of changing arguments of verb on passive drop") +
  ylab("Change in passive drop") +
  theme(legend.position = "bottom",
        #axis.text.x = element_text(angle = 45, vjust = 1, hjust=1),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())
```

```{r}
minicons_all_scores_by_frame %>% 
  rowwise() %>%
  mutate(differences_freq = list(as.list(outer(default, frequency, function(x,y) {x-y}))),
         differences_swap = list(as.list(outer(default, swap, function(x,y) {x-y}))),
         altered = get_lemma(verb) == target_verb) %>%
  group_by(source_verb, target_verb, altered) %>%
  summarise(differences_freq = list(unlist(list(differences_freq))),
            differences_swap = list(unlist(list(differences_swap)))) %>%
  mutate(mean_freq_diff = sapply(differences_freq, mean),
          error_freq_diff = lapply(differences_freq, bayesian_error)) %>%
  unnest_wider(error_freq_diff, names_sep="_") %>%
  ggplot(aes(y=mean_freq_diff, x=altered, 
             fill=altered,
             ymin=error_freq_diff_1, ymax=error_freq_diff_2)) +
  facet_grid(cols=vars(target_verb), rows=vars(source_verb)) +
  geom_bar(stat="identity") +
  geom_errorbar(width=0.1) +
  labs(fill="Intervened verb",
       title="Effect of changing frequency of verb on passive drop") +
  ylab("Change in passive drop") +
  theme(legend.position = "bottom",
        axis.text.x = element_text(angle = 45, vjust = 1, hjust=1),
        axis.title.x=element_blank(),
        #axis.ticks.x=element_blank()
        )
```

```{r}
minicons_all_scores_by_frame %>% 
  rowwise() %>%
  mutate(differences_freq = list(as.list(outer(default, frequency, function(x,y) {x-y}))),
         differences_swap = list(as.list(outer(default, swap, function(x,y) {x-y}))),
         altered = get_lemma(verb) == source_verb) %>%
  group_by(source_verb, target_verb, altered) %>%
  summarise(differences_swap = list(unlist(list(differences_swap)))) %>%
  mutate(mean_swap_diff = sapply(differences_swap, mean),
          error_swap_diff = lapply(differences_swap, bayesian_error)) %>%
  unnest_wider(error_swap_diff, names_sep="_") %>%
  ggplot(aes(y=mean_swap_diff, x=altered, 
             fill=altered,
             ymin=error_swap_diff_1, ymax=error_swap_diff_2)) +
  facet_grid(cols=vars(source_verb), rows=vars(target_verb)) +
  geom_bar(stat="identity") +
  geom_errorbar(width=0.1) +
  labs(fill="Intervened verb",
       x="Is verb targeted?",
      title="Effect of changing arguments of verb on passive drop") +
  ylab("Change in passive drop") +
  theme(legend.position = "bottom",
        axis.text.x = element_text(angle = 45, vjust = 1, hjust=1),
        axis.title.x=element_blank(),
        #axis.ticks.x=element_blank()
        )
```

```{r}
counts_all %>% 
  filter(verb != "wash" & (verb_class == "Agent-Patient" | verb_class == "Duration")) %>%
  filter(sentence_type == "active" | sentence_type == "passive") %>%
  mutate(verb = factor(verb, levels=c("push", "hit", "carry", "drop", "last", "take", "require")),
         corpus = factor(corpus, levels= c("original", "lastdrop"))) %>%
  ggplot(aes(x=verb, y=score, fill=sentence_type,)) +
  geom_col(position="dodge") +
  facet_wrap(vars(corpus), labeller = as_labeller(c("original" = "Original",
                                                    "lastdrop" = "Modified: Drop \u2192 Last"))) +
  scale_y_log10(breaks = c(0,10,100,1000,10000,100000),
                labels=scales::number) +
  scale_fill_manual(labels = c("Active Transitive", "Passive"),
                    values=sent_type_colours) +
  labs(fill=element_blank(),
       x=element_blank(),
       y="Number of occurrences in corpus") + 
  theme(legend.position="bottom")

ggsave(here("analysis", "corpus_comparison_frequency.pdf"), device="pdf", width=10, height=4, units = "in")

```

```{r}
counts_all_swap %>% 
  filter(verb != "wash" & (verb_class == "Agent-Patient" | verb_class == "Duration")) %>%
  filter(sentence_type!= "all") %>%
  mutate(verb = factor(verb, levels=c("push", "hit", "carry", "drop", "last", "take", "require")),
         sentence_type = factor(sentence_type, levels=c("active", "passive", "other")),
         corpus = factor(corpus, levels= c("original", "swap"))) %>%
  ggplot(aes(x=verb, y=score, fill=sentence_type,)) +
  geom_col(position="dodge") +
  facet_wrap(vars(corpus), labeller = as_labeller(c("original" = "Original",
                                                    "swap" = "Modified: Drop \u2192 Last"))) +
  scale_y_log10(breaks = c(0,10,100,1000,10000,100000),
                labels=scales::number) +
  scale_fill_manual(labels = c("Active Transitive", "Passive", "Other"),
                  values=c("#882255", "#4491EE", "#999933")) +
  labs(fill="Sentence type",
       x=element_blank(),
       y="Number of occurrences in corpus") + 
  theme(legend.position="bottom")

ggsave(here("analysis", "corpus_comparison_swap.pdf"), device="pdf", width=10, height=4, units = "in")
```

```{r}
counts_original %>% 
  pivot_longer(cols=c("active", "passive", "other"), names_to = "sentence_type", values_to = "score") %>%
  mutate(verb_class = get_verb_class(verb),
         sentence_type = factor(sentence_type, levels=c("active", "passive", "other"))) %>%
  filter(verb != "wash" & (verb_class == "Agent-Patient" | verb_class == "Duration")) %>%
  mutate(verb = factor(verb, levels=c("push", "hit", "carry", "drop", "last", "take", "require"))) %>%
  ggplot(aes(x=verb, y=score, fill=sentence_type)) +
  facet_wrap(vars(verb_class), scales="free_x") +
  geom_col(position="dodge") +
  scale_y_log10(breaks = c(0,10,100,1000,10000,100000),
                labels=scales::number) +
  labs(fill=element_blank(),
       x=element_blank(),
       y="Number of occurrences in corpus") +
  scale_fill_manual(labels = c("Active Transitive", "Passive", "Other"),
                    values=c("#882255", "#4491EE", "#999933")) +
  theme(legend.position = "bottom")

ggsave(here("analysis", "original_corpus.pdf"), device="pdf", width=8, height=4, units = "in")

```

```{r}
counts_original %>%
  mutate(diff = active/passive)
```

```{r}
df <- tibble(
  act_freq <- c(7692, 3279, 9386, 4479,683, 82813, 13352),
  pass_freq <- c(2185,1146,2479,1272,4,10217,5260),
  verb_labels <- c("carry", "drop", "hit", "push", "last", "take", "require")
) 

df %>% ggplot(aes(x=verb_labels, y=act_freq)) + 
  geom_bar(stat='identity')

```
